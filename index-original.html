<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Valor IVX — Sample Frontend (Standalone, Improved)</title>
<link rel="stylesheet" href="./styles.css">
<meta name="color-scheme" content="light dark" />
<link rel="prefetch" href="./js/modules/advanced-charting.js" as="script" />
<link rel="prefetch" href="./js/modules/video-conference.js" as="script" />
</head>
<body>
  <a class="skip-link" href="#main">Skip to main content</a>
  <header class="app-header" role="banner">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Valor IVX</h1>
        <small>Standalone DCF + Sensitivity — Improved Frontend</small>
      </div>
    </div>
    <nav class="actions" role="navigation" aria-label="Main actions">
      <div class="nav-links" role="navigation" aria-label="Modules">
        <a href="./index.html" class="link" aria-current="page">DCF</a>
        <a href="./lbo.html" class="link">LBO</a>
        <a href="./ma.html" class="link">M&A</a>
        <a href="./real-options.html" class="link">Real Options</a>
      </div>
      <!-- Primary Actions -->
      <div class="primary-actions">
        <button id="runModel" class="primary" aria-describedby="run-help">
          <span class="kbd">⏎</span>
          Run Analysis
        </button>
        <div id="run-help" class="sr-only">Executes DCF valuation model with current assumptions</div>
        
        <button id="presetExample" title="Load demo data" aria-describedby="preset-help">
          <span class="kbd">P</span>
          Preset
        </button>
        <div id="preset-help" class="sr-only">Loads predefined example values for quick DCF analysis</div>
      </div>
      
      <!-- Secondary Actions -->
      <div class="secondary-actions">
<div class="dropdown" id="toolsDropdown">
  <button class="dropdown-toggle" aria-expanded="false" aria-haspopup="true" tabindex="0">
    Tools
    <span class="dropdown-arrow">▾</span>
  </button>
  <div class="dropdown-menu" role="menu" hidden>
    <button id="openSolver" role="menuitem" tabindex="-1">Solver</button>
    <button id="resetForm" role="menuitem" tabindex="-1">Reset Form</button>
    <button id="resetAll" role="menuitem" tabindex="-1">Reset All</button>
  </div>
</div>
        
<div class="dropdown" id="dataDropdown">
  <button class="dropdown-toggle" aria-expanded="false" aria-haspopup="true" tabindex="0">
    Data
    <span class="dropdown-arrow">▾</span>
  </button>
  <div class="dropdown-menu" role="menu" hidden>
    <button id="exportJSON" role="menuitem" tabindex="-1">Export JSON</button>
    <button id="importJSON" role="menuitem" tabindex="-1">Import JSON</button>
    <button id="exportCSV" role="menuitem" tabindex="-1">Export CSV</button>
    <button id="copyLink" role="menuitem" tabindex="-1">Copy Link</button>
    <div class="dropdown-divider"></div>
    <button id="sendRun" role="menuitem" tabindex="-1">Save to Backend</button>
    <button id="loadLastRun" role="menuitem" tabindex="-1">Load from Backend</button>
  </div>
</div>
        
        <button id="openLBO" class="module-switch" onclick="window.location.href='./lbo.html'">
          LBO Model
        </button>
        <button id="openMA" class="module-switch" onclick="window.location.href='./ma.html'">
          M&A Model
        </button>
      </div>
      
      <!-- Hidden Elements -->
      <input id="importJSONFile" type="file" accept="application/json" style="display:none" />
      <div id="reset-help" class="sr-only">Resets current form inputs to default values</div>
      <div id="reset-all-help" class="sr-only">Clears all data including scenarios, notes, and settings</div>
      <button id="sendScenarios" style="display:none">Send Scenarios</button>
      <button id="fetchScenarios" style="display:none">Fetch Scenarios</button>
    </nav>
  </header>

  <main id="main" class="layout">
    <!-- Left: Inputs -->
    <section class="panel" role="region" aria-labelledby="inputsTitle">
      <h2 id="inputsTitle">Financial Assumptions</h2>

      <div class="section">
        <div class="grid">
          <div class="col">
            <label for="ticker">Company / Ticker</label>
            <input id="ticker" type="text" value="SAMPLE" placeholder="e.g., SAMPLE" title="Company ticker or label" aria-describedby="ticker-hint" />
            <span class="hint">Label only. No network calls in this demo.</span>
          </div>
          <div class="col">
            <label for="revenue">Current Revenue (MM)</label>
            <div class="input-affix">
              <input id="revenue" type="number" step="0.01" value="500" placeholder="e.g., 500" title="Current revenue in USD millions" aria-describedby="revenue-unit" inputmode="decimal" pattern="[0-9]*\.?[0-9]*" />
              <span class="affix" id="revenue-unit" aria-label="Million US Dollars">$MM</span>
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="grid">
          <div class="col">
            <label for="growthY1">Year 1 Growth %</label>
            <div class="input-affix">
              <input id="growthY1" type="number" step="0.1" value="12" placeholder="e.g., 12.0" title="Year 1 revenue growth in percent" inputmode="decimal" pattern="[0-9]*\.?[0-9]*" />
              <span class="affix">%</span>
            </div>
          </div>
          <div class="col">
            <label for="growthDecay">Growth Decay (pp/yr)</label>
            <div class="input-affix">
              <input id="growthDecay" type="number" step="0.1" value="1.5" placeholder="e.g., 1.5" title="Growth decay in percentage points per year" inputmode="decimal" pattern="[0-9]*\.?[0-9]*" />
              <span class="affix">pp</span>
            </div>
            <span class="hint">Decline in growth rate per year</span>
          </div>
          <div class="col">
            <label for="years">Projection Years</label>
            <input id="years" type="number" min="3" max="15" value="7" placeholder="3 to 15" title="Projection period in years" inputmode="numeric" pattern="[0-9]*" />
          </div>
          <div class="col">
            <label for="termGrowth">Terminal Growth %</label>
            <div class="input-affix">
              <input id="termGrowth" type="number" step="0.1" value="2.5" placeholder="e.g., 2.5" title="Terminal growth rate in percent" inputmode="decimal" pattern="[0-9]*\.?[0-9]*" />
              <span class="affix">%</span>
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="grid">
          <div class="col">
            <label for="ebitMargin">EBIT Margin % (steady-state)</label>
            <div class="input-affix">
              <input id="ebitMargin" type="number" step="0.1" value="22" placeholder="e.g., 22.0" title="EBIT margin in percent" />
              <span class="affix">%</span>
            </div>
          </div>
          <div class="col">
            <label for="taxRate">Tax Rate %</label>
            <div class="input-affix">
              <input id="taxRate" type="number" step="0.1" value="23" placeholder="e.g., 23.0" title="Effective tax rate in percent" />
              <span class="affix">%</span>
            </div>
          </div>
          <div class="col">
            <label for="salesToCap">Sales-to-Capital</label>
            <input id="salesToCap" type="number" step="0.01" value="2.5" placeholder="e.g., 2.5" title="Sales-to-Capital ratio" inputmode="decimal" pattern="[0-9]*\.?[0-9]*" />
            <span class="hint">Revenue added per $1 new capital (higher = less reinvestment)</span>
          </div>
          <div class="col">
            <label for="wacc">WACC %</label>
            <div class="input-affix">
              <input id="wacc" type="number" step="0.1" value="9.0" placeholder="e.g., 9.0" title="Weighted Average Cost of Capital in percent" inputmode="decimal" pattern="[0-9]*\.?[0-9]*" />
              <span class="affix">%</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Terminal Value Method -->
      <div class="section" aria-labelledby="tvTitle">
        <h2 id="tvTitle">Terminal Value</h2>
        <div class="grid">
          <div class="col">
            <label>Method</label>
            <div class="row" role="group" aria-label="Terminal method">
              <label class="subtle"><input type="radio" name="tvMethod" id="tvPerp" value="perpetuity" checked /> Perpetuity (Gordon)</label>
              <label class="subtle"><input type="radio" name="tvMethod" id="tvMultiple" value="multiple" /> Exit Multiple (EV/FCFF)</label>
            </div>
          </div>
          <div class="col">
            <label for="tvMultipleVal">EV / FCFF Multiple</label>
            <input id="tvMultipleVal" type="number" step="0.1" value="12.0" placeholder="e.g., 12.0" title="Exit multiple on next-year FCFF" disabled />
            <span class="hint">Enabled when Exit Multiple is selected</span>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="grid">
          <div class="col">
            <label for="shares">Shares Outstanding (MM)</label>
            <div class="input-affix">
              <input id="shares" type="number" step="0.01" value="150" placeholder="e.g., 150" title="Shares outstanding in millions" inputmode="decimal" pattern="[0-9]*\.?[0-9]*" />
              <span class="affix">MM</span>
            </div>
          </div>
          <div class="col">
            <label for="netDebt">Net Debt (MM)</label>
            <div class="input-affix">
              <input id="netDebt" type="number" step="0.01" value="300" placeholder="e.g., 300" title="Net debt in USD millions" inputmode="decimal" pattern="[0-9]*\.?[0-9]*" />
              <span class="affix">$MM</span>
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="grid">
          <div class="col">
            <label for="waccMin">Sensitivity: WACC Min %</label>
            <div class="input-affix">
              <input id="waccMin" type="number" step="0.1" value="7" placeholder="min %" title="Sensitivity WACC min in percent" />
              <span class="affix">%</span>
            </div>
          </div>
          <div class="col">
            <label for="waccMax">Sensitivity: WACC Max %</label>
            <div class="input-affix">
              <input id="waccMax" type="number" step="0.1" value="12" placeholder="max %" title="Sensitivity WACC max in percent" />
              <span class="affix">%</span>
            </div>
          </div>
          <div class="col">
            <label for="tgMin">Sensitivity: g Min %</label>
            <div class="input-affix">
              <input id="tgMin" type="number" step="0.1" value="1.0" placeholder="min %" title="Sensitivity terminal g min in percent" />
              <span class="affix">%</span>
            </div>
          </div>
          <div class="col">
            <label for="tgMax">Sensitivity: g Max %</label>
            <div class="input-affix">
              <input id="tgMax" type="number" step="0.1" value="3.5" placeholder="max %" title="Sensitivity terminal g max in percent" />
              <span class="affix">%</span>
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="row">
          <button id="btnRunLeft" class="primary">Run Analysis</button>
          <span class="subtle">Press Enter anywhere to run • P for preset data</span>
        </div>
      </div>

      <!-- Multi-Stage Ramps -->
      <div class="section" aria-labelledby="rampsTitle">
        <div class="row" style="justify-content:space-between; align-items:center;">
          <h2 id="rampsTitle">Assumption Ramps (Multi-Stage)</h2>
          <span class="subtle">Preview updates live</span>
        </div>
        <div class="grid">
          <div class="col">
            <label for="stage1End">Stage 1 Ends (Year)</label>
            <input id="stage1End" type="number" min="1" value="3" placeholder="e.g., 3" title="Stage 1 ends at year" />
            <span class="hint">Stage 1 ends at this projection year</span>
          </div>
          <div class="col">
            <label for="stage2End">Stage 2 Ends (Year)</label>
            <input id="stage2End" type="number" min="2" value="6" placeholder="e.g., 6" title="Stage 2 ends at year" />
            <span class="hint">Stage 2 ends at this projection year</span>
          </div>
        </div>
        <div class="divider"></div>
        <div class="grid">
          <div class="col">
            <label>Stage 1 Growth %</label>
            <div class="input-affix">
              <input id="s1Growth" type="number" step="0.1" value="12.0" placeholder="% growth" title="Stage 1 revenue growth in percent" />
              <span class="affix">%</span>
            </div>
          </div>
          <div class="col">
            <label>Stage 1 EBIT Margin %</label>
            <div class="input-affix">
              <input id="s1Margin" type="number" step="0.1" value="20.0" placeholder="% margin" title="Stage 1 EBIT margin in percent" />
              <span class="affix">%</span>
            </div>
          </div>
          <div class="col">
            <label>Stage 1 Sales-to-Capital</label>
            <input id="s1S2C" type="number" step="0.1" value="2.5" placeholder="S2C" title="Stage 1 Sales-to-Capital" />
          </div>
          <div class="col">
            <label>Stage 1 NWC % of Revenue</label>
            <div class="input-affix">
              <input id="s1NWC" type="number" step="0.1" value="5.0" placeholder="% NWC" title="Stage 1 Net Working Capital as % of revenue" />
              <span class="affix">%</span>
            </div>
          </div>
        </div>
        <div class="grid">
          <div class="col">
            <label>Stage 2 Growth %</label>
            <div class="input-affix">
              <input id="s2Growth" type="number" step="0.1" value="8.0" placeholder="% growth" title="Stage 2 revenue growth in percent" />
              <span class="affix">%</span>
            </div>
          </div>
          <div class="col">
            <label>Stage 2 EBIT Margin %</label>
            <div class="input-affix">
              <input id="s2Margin" type="number" step="0.1" value="22.0" placeholder="% margin" title="Stage 2 EBIT margin in percent" />
              <span class="affix">%</span>
            </div>
          </div>
          <div class="col">
            <label>Stage 2 Sales-to-Capital</label>
            <input id="s2S2C" type="number" step="0.1" value="3.0" placeholder="S2C" title="Stage 2 Sales-to-Capital" />
          </div>
          <div class="col">
            <label>Stage 2 NWC % of Revenue</label>
            <div class="input-affix">
              <input id="s2NWC" type="number" step="0.1" value="4.0" placeholder="% NWC" title="Stage 2 Net Working Capital as % of revenue" />
              <span class="affix">%</span>
            </div>
          </div>
        </div>
        <div class="grid">
          <div class="col">
            <label>Stage 3 Growth %</label>
            <div class="input-affix">
              <input id="s3Growth" type="number" step="0.1" value="4.0" placeholder="% growth" title="Stage 3 revenue growth in percent" />
              <span class="affix">%</span>
            </div>
          </div>
          <div class="col">
            <label>Stage 3 EBIT Margin %</label>
            <div class="input-affix">
              <input id="s3Margin" type="number" step="0.1" value="24.0" placeholder="% margin" title="Stage 3 EBIT margin in percent" />
              <span class="affix">%</span>
            </div>
          </div>
          <div class="col">
            <label>Stage 3 Sales-to-Capital</label>
            <input id="s3S2C" type="number" step="0.1" value="3.5" placeholder="S2C" title="Stage 3 Sales-to-Capital" />
          </div>
          <div class="col">
            <label>Stage 3 NWC % of Revenue</label>
            <div class="input-affix">
              <input id="s3NWC" type="number" step="0.1" value="3.5" placeholder="% NWC" title="Stage 3 Net Working Capital as % of revenue" />
              <span class="affix">%</span>
            </div>
          </div>
        </div>
        <div class="row" style="margin-top:8px; gap:8px; align-items:center;">
          <span class="subtle">Ramp Preview</span>
        </div>
        <canvas id="rampPreview" width="800" height="180" aria-label="Multi-stage assumption ramp preview showing projected growth, margins, and metrics over time" role="img" tabindex="0"></canvas>
      </div>
    </section>

    <!-- Right: Outputs -->
    <section class="panel" aria-labelledby="outputsTitle">
      <div class="right-header">
        <h2 id="outputsTitle">Valuation Output</h2>
        <div class="row" style="gap:6px; align-items:center">
          <span class="pill" id="statusPill" role="status" aria-live="polite">Idle</span>
          <span class="pill" id="backendPill" role="status" title="Backend connectivity">Backend: Unknown</span>
        </div>
      </div>

      <div class="outputs" aria-live="polite">
        <div class="metric">
          <div class="k">Enterprise Value</div>
          <div class="v" id="evVal">—</div>
        </div>
        <div class="metric">
          <div class="k">Equity Value</div>
          <div class="v" id="eqVal">—</div>
        </div>
        <div class="metric">
          <div class="k">Per Share</div>
          <div class="v" id="psVal">—</div>
        </div>
        <div class="metric">
          <div class="k">Terminal Value % of EV</div>
          <div class="v" id="tvPct">—</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="charts">
        <div>
          <div class="tabs" role="tablist" aria-label="Left data views">
            <button class="tab active" role="tab" aria-selected="true" data-tab="fcf">FCFF</button>
            <button class="tab" role="tab" aria-selected="false" data-tab="rev">Revenue</button>
            <button class="tab" role="tab" aria-selected="false" data-tab="margin">Margins</button>
            <button class="tab" role="tab" aria-selected="false" data-tab="pv">PV Contributions</button>
            <button class="tab" role="tab" aria-selected="false" data-tab="waterfall">EV Waterfall</button>
            <button class="tab" role="tab" aria-selected="false" data-tab="sensi1d">1D Sensitivity</button>
          </div>
          <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:6px">
            <div class="subtle" id="seriesTitle">Projected FCFF</div>
            <div class="subtle" id="fcffSummary">—</div>
          </div>
          <div class="legend" id="chartLegend">
            <span class="item"><span class="sw" style="background:#72efdd"></span>Series</span>
            <span class="item" id="legendOverlay" style="display:none"><span class="sw" style="background:#ffd166"></span><span id="overlayLabel">Overlay Scenario</span></span>
          </div>
          <div class="chartbar">
            <button id="overlaySave" title="Save current series as overlay">Save Overlay</button>
            <button id="overlayClear" title="Clear overlay series">Clear Overlay</button>
            <button id="exportChart" title="Export left chart as PNG">Export PNG</button>
          </div>
          <div class="chart-wrap">
            <canvas id="fcfChart" width="800" height="300" aria-label="Projected financial chart showing DCF analysis results" role="img" tabindex="0"></canvas>
            <div id="chartTooltip" class="tooltip" role="tooltip" style="display:none"></div>
          </div>
          <div class="row" style="gap:8px; margin-top:6px; flex-wrap:wrap" id="sensi1dControls" hidden>
            <label class="subtle">Axis:</label>
            <select id="s1dAxis" title="Sensitivity Axis" class="select">
              <option value="wacc">WACC (%)</option>
              <option value="termGrowth">Terminal g (%)</option>
              <option value="ebitMargin">EBIT Margin (%)</option>
              <option value="salesToCap">Sales-to-Capital</option>
            </select>
            <input id="s1dMin" type="number" step="0.1" value="7.0" class="compact" title="Min" placeholder="min" aria-label="Min"/>
            <input id="s1dMax" type="number" step="0.1" value="12.0" class="compact" title="Max" placeholder="max" aria-label="Max"/>
            <input id="s1dSteps" type="number" step="1" value="20" class="compact" title="Steps" placeholder="steps" aria-label="Steps"/>
            <button id="runS1D">Plot</button>
          </div>
          <div class="row" style="gap:8px; margin-top:6px; flex-wrap:wrap">
            <label class="subtle" aria-label="Monte Carlo trials count">Monte Carlo trials:</label>
            <input id="mcTrials" type="number" min="100" max="10000" value="1000" class="compact" title="Number of Monte Carlo trials" placeholder="Trials" aria-label="Monte Carlo trials" />
            <label class="subtle" aria-label="Growth volatility in percentage points">Growth vol (pp):</label>
            <input id="mcVol" type="number" step="0.1" value="2.0" class="compact" title="Growth volatility in percentage points" placeholder="pp" aria-label="Growth volatility in percentage points" />
            <label class="subtle" aria-label="Deterministic seed string for reproducibility">Seed:</label>
            <input id="mcSeed" type="text" class="compact" placeholder="e.g., analysis-1" title="Deterministic seed for reproducible MC" aria-label="Deterministic seed"/>
            <div class="advanced-mc-box" role="group" aria-label="Advanced Monte Carlo settings">
              <div class="subtle legend">Advanced MC</div>
              <label class="subtle" aria-label="EBIT margin volatility in percentage points">Margin vol (pp):</label>
              <input id="mcMarginVol" type="number" step="0.1" class="compact" placeholder="defaults to Growth vol" title="EBIT margin volatility in percentage points" aria-label="Margin volatility in percentage points"/>
              <span class="hint" style="width:100%">Margin vol (pp): absolute percentage points on margins; blank → uses Growth vol</span>
              <label class="subtle" aria-label="Sales-to-Capital relative volatility percentage">S2C vol (%):</label>
              <input id="mcS2CVol" type="number" step="0.1" class="compact" placeholder="5" title="Sales-to-Capital relative volatility in percent" aria-label="Sales-to-Capital relative volatility percent"/>
              <span class="hint" style="width:100%">S2C vol (%): relative percent on S2C (multiplicative)</span>
              <label class="subtle" aria-label="Correlation between growth and margin shocks">Corr(G↔M):</label>
              <input id="mcCorrGM" type="number" step="0.05" min="-0.99" max="0.99" class="compact" placeholder="0.30" title="Correlation between stage-1 growth and margin shocks (-0.99 to 0.99)" aria-label="Correlation G and M"/>
              <span class="hint" style="width:100%">Corr(G↔M): correlation between stage-1 growth and margin shocks (clamped to -0.99…0.99)</span>
            </div>
            <button id="runMC">Run Monte Carlo</button>
            <button id="cancelMC" style="display:none" title="Cancel Monte Carlo run">Cancel MC</button>
            <span class="subtle" id="mcSummary">—</span>
          </div>
          <div class="row" style="gap:8px; align-items:center; margin-top:4px">
            <label class="subtle" for="toggleHistAnn">Show annotations (μ, med, p10, p90)</label>
            <input id="toggleHistAnn" type="checkbox" class="compact" aria-label="Toggle histogram annotations"/>
          </div>
          <canvas id="mcHist" width="800" height="180" aria-label="Monte Carlo simulation histogram showing distribution of per-share valuations" role="img" tabindex="0" style="margin-top:8px"></canvas>
          <div class="legend" id="histLegend" aria-hidden="true" style="display:none">
            <span class="item"><span class="sw" style="background:#72efdd"></span>μ</span>
            <span class="item"><span class="sw" style="background:#cfe3f7"></span>med</span>
            <span class="item"><span class="sw" style="background:#ffd166"></span>p10</span>
            <span class="item"><span class="sw" style="background:#ffd166"></span>p90</span>
          </div>
        </div>
        <div>
          <div class="tabs" role="tablist" aria-label="Right data views">
            <button class="tab active" role="tab" aria-selected="true" data-tab="sens">WACC vs g</button>
            <button class="tab" role="tab" aria-selected="false" data-tab="twoWay">Two-way Grid</button>
            <button class="tab" role="tab" aria-selected="false" data-tab="tvm">TV Mix</button>
            <button class="tab" role="tab" aria-selected="false" data-tab="tornado">Tornado</button>
          </div>
          <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:6px">
            <div class="subtle" id="sensTitle">Sensitivity: WACC vs Terminal Growth</div>
            <div class="subtle">Green = higher per-share value</div>
            <div class="chartbar" style="margin-left:auto">
              <button id="exportHeatmap" title="Export right chart as PNG">Export Heatmap PNG</button>
              <button id="exportTornado" title="Export tornado chart as PNG">Export Tornado PNG</button>
            </div>
          </div>
          <div class="row" style="gap:8px; margin:6px 0; flex-wrap:wrap" id="tvMiniPanel">
            <span class="pill">TV Method: <strong id="tvInfoMethod">—</strong></span>
            <span class="pill">PV(TV): <strong id="tvInfoPVTV">—</strong></span>
            <span class="pill">PV(FCFF): <strong id="tvInfoPVPV">—</strong></span>
            <span class="pill">TV% EV: <strong id="tvInfoPct">—</strong></span>
            <span class="pill" id="tvInfoImpliedMultWrap" style="display:none;">Implied EV/FCFF: <strong id="tvInfoImpliedMult">—</strong></span>
            <span class="pill" id="tvInfoImpliedGWrap" style="display:none;">Implied g: <strong id="tvInfoImpliedG">—</strong></span>
          </div>
          <canvas id="heatmap" width="800" height="300" aria-label="Sensitivity analysis heatmap showing valuation ranges across different WACC and growth assumptions" role="img" tabindex="0"></canvas>
          <canvas id="tornadoChart" width="800" height="300" aria-label="Tornado chart" style="margin-top:8px; display:none"></canvas>
          <div id="tornadoControls" class="row" style="gap:8px; margin-top:6px; flex-wrap:wrap; display:none">
            <label class="subtle">Tornado Deltas:</label>
            <input id="tornadoWacc" type="number" step="0.1" value="1.0" class="compact" title="WACC Delta (%)" placeholder="WACC Δ" aria-label="WACC Delta"/>
            <input id="tornadoG" type="number" step="0.1" value="0.5" class="compact" title="Terminal g Delta (%)" placeholder="g Δ" aria-label="Terminal g Delta"/>
            <input id="tornadoMargin" type="number" step="0.1" value="1.0" class="compact" title="EBIT Margin Delta (%)" placeholder="Margin Δ" aria-label="EBIT Margin Delta"/>
            <input id="tornadoS2C" type="number" step="0.1" value="0.2" class="compact" title="Sales-to-Capital Delta" placeholder="S2C Δ" aria-label="Sales-to-Capital Delta"/>
            <select id="tornadoMetric" title="Tornado Output Metric" class="select">
              <option value="perShare">Per Share</option>
              <option value="ev">Enterprise Value</option>
            </select>
          </div>
          <div class="row" style="gap:8px; margin-top:6px; flex-wrap:wrap">
            <label class="subtle">Compare scenarios:</label>
            <button id="saveScenario" title="Save current assumptions as scenario A/B/C">Save Scenario</button>
            <select id="scenarioSelect" title="Select saved scenario to apply" class="select">
              <option value="">— Saved Scenarios —</option>
            </select>
            <button id="applyScenario">Apply</button>
            <button id="deleteScenario">Delete</button>
            <button id="exportScenarios" title="Export saved scenarios as JSON">Export Scenarios</button>
            <button id="importScenarios" title="Import scenarios JSON">Import Scenarios</button>
            <input id="importScenariosFile" type="file" accept="application/json" style="display:none" />
            <span class="hint" aria-label="Scenarios include Monte Carlo settings snapshot" title="Scenarios include MC settings">Scenarios include MC settings</span>
          </div>
          <div class="row" style="gap:8px; margin-top:8px; flex-wrap:wrap">
            <label class="subtle">Two-way grid axes:</label>
            <select id="axisX" title="X axis" class="select">
              <option value="wacc">WACC</option>
              <option value="termGrowth">Terminal g</option>
              <option value="ebitMargin">EBIT Margin</option>
              <option value="salesToCap">Sales-to-Capital</option>
            </select>
            <input id="xMin" type="number" step="0.1" value="7.0" class="compact" title="X min (for % inputs, use %)" placeholder="min" aria-label="X min"/>
            <input id="xMax" type="number" step="0.1" value="12.0" class="compact" title="X max (for % inputs, use %)" placeholder="max" aria-label="X max"/>
            <select id="axisY" title="Y axis" class="select">
              <option value="termGrowth">Terminal g</option>
              <option value="wacc">WACC</option>
              <option value="ebitMargin">EBIT Margin</option>
              <option value="salesToCap">Sales-to-Capital</option>
            </select>
            <input id="yMin" type="number" step="0.1" value="1.0" class="compact" title="Y min" placeholder="min" aria-label="Y min"/>
            <input id="yMax" type="number" step="0.1" value="3.5" class="compact" title="Y max" placeholder="max" aria-label="Y max"/>
            <button id="runTwoWay">Run 2D Grid</button>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Solver Modal -->
      <div id="solverModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); backdrop-filter:saturate(120%) blur(2px); -webkit-backdrop-filter:saturate(120%) blur(2px); z-index:50; align-items:center; justify-content:center;">
        <div class="modal">
          <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
            <div class="subtle">Implied Metric Solver</div>
            <button id="closeSolver">Close</button>
          </div>
          <div class="grid">
            <div class="col">
              <label for="solverTarget">Target Per-Share ($)</label>
              <input id="solverTarget" type="number" step="0.01" value="50" />
            </div>
            <div class="col">
              <label for="solverType">Solve For</label>
              <select id="solverType" class="select">
                <option value="wacc">Implied WACC (%)</option>
                <option value="termGrowth">Implied Terminal g (%)</option>
              </select>
            </div>
          </div>
          <div class="grid" style="margin-top:8px">
            <div class="col">
              <label for="solverMin">Min</label>
              <input id="solverMin" type="number" step="0.01" value="5.0" />
            </div>
            <div class="col">
              <label for="solverMax">Max</label>
              <input id="solverMax" type="number" step="0.01" value="15.0" />
            </div>
          </div>
          <div class="row" style="gap:8px;margin-top:8px">
            <button id="runSolver" class="primary">Solve</button>
            <span class="subtle" id="solverStatus">—</span>
          </div>
          <div class="terminal" id="solverLog" style="margin-top:8px;height:160px" aria-live="polite"></div>
        </div>
      </div>

      <div class="row" style="gap:12px; flex-wrap:wrap">
        <div style="flex:1; min-width:320px">
          <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:6px">
            <div class="subtle">Assumption Log</div>
            <div class="row" style="gap:6px">
              <button id="copyLog">Copy Log</button>
              <button id="clearLog">Clear Log</button>
            </div>
          </div>
          <div class="terminal" id="terminal" aria-live="polite"></div>
        </div>
        <div style="flex:1; min-width:320px">
          <div class="row" style="justify-content:space-between; align-items:center; margin:6px 0">
            <div class="subtle">Analyst Notes</div>
            <div class="row" style="gap:6px">
              <button id="saveNotes">Save Notes</button>
              <button id="clearNotes">Clear</button>
            </div>
          </div>
          <textarea id="notesArea" class="notes" placeholder="Write investment thesis, risks, and catalysts..."></textarea>
          <div class="divider"></div>
          <div class="subtle" style="margin:6px 0">Key Ratios (derived)</div>
          <table class="kpitable" id="kpiTable" aria-label="Derived metrics table">
            <thead>
              <tr><th>Metric</th><th>Value</th></tr>
            </thead>
            <tbody>
              <tr><td>ROIC (approx)</td><td id="kpiROIC">—</td></tr>
              <tr><td>Reinvestment Rate</td><td id="kpiReinv">—</td></tr>
              <tr><td>FCFF CAGR</td><td id="kpiFcfCAGR">—</td></tr>
              <tr><td>Payback (yrs, PV-based)</td><td id="kpiPayback">—</td></tr>
              <tr><td>EV / NOPAT (Yr N)</td><td id="kpiEVNOPAT">—</td></tr>
            </tbody>
          </table>
        </div>
        <div style="flex:1; min-width:320px">
          <div class="row" style="justify-content:space-between; align-items:center; margin:6px 0">
            <div class="subtle">In-Browser CLI</div>
            <div class="row" style="gap:6px">
              <span class="pill">Type 'help' for commands</span>
            </div>
          </div>
          <div class="cli" role="region" aria-label="CLI Terminal">
            <div class="cli-output" id="cliOutput"></div>
            <div class="cli-input">
              <input id="cliInput" type="text" placeholder="Enter command e.g.: run, set wacc 8.5, eval ps, mc 500 2.0, grid wacc 7 12 g 1 3" aria-label="CLI input"/>
              <button id="cliExec">Exec</button>
            </div>
          </div>
        </div>
      </div>
      </div>
    </section>
  </main>

<script type="module" src="./js/main.js"></script>
<script type="module">
  // Accessible dropdown keyboard handling
  function wireDropdown(dropdownId) {
    const root = document.getElementById(dropdownId);
    if (!root) return;
    const toggle = root.querySelector('.dropdown-toggle');
    const menu = root.querySelector('.dropdown-menu');
    if (!toggle || !menu) return;

    function openMenu() {
      menu.hidden = false;
      toggle.setAttribute('aria-expanded', 'true');
      // set roving tabindex for items
      const items = menu.querySelectorAll('[role="menuitem"]');
      items.forEach((el, i) => el.setAttribute('tabindex', i === 0 ? '0' : '-1'));
      items[0]?.focus();
    }
    function closeMenu() {
      menu.hidden = true;
      toggle.setAttribute('aria-expanded', 'false');
      toggle.focus();
    }
    function isOpen() { return menu.hidden === false; }

    toggle.addEventListener('click', (e) => {
      e.stopPropagation();
      isOpen() ? closeMenu() : openMenu();
    });
    toggle.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowDown' || e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        openMenu();
      }
    });

    menu.addEventListener('keydown', (e) => {
      const items = Array.from(menu.querySelectorAll('[role="menuitem"]'));
      const idx = items.indexOf(document.activeElement);
      if (e.key === 'Escape') {
        e.preventDefault();
        closeMenu();
      } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        const next = items[(idx + 1) % items.length];
        items.forEach(el => el.setAttribute('tabindex', '-1'));
        next.setAttribute('tabindex', '0');
        next.focus();
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        const prev = items[(idx - 1 + items.length) % items.length];
        items.forEach(el => el.setAttribute('tabindex', '-1'));
        prev.setAttribute('tabindex', '0');
        prev.focus();
      } else if (e.key === 'Home') {
        e.preventDefault();
        items.forEach(el => el.setAttribute('tabindex', '-1'));
        items[0].setAttribute('tabindex', '0');
        items[0].focus();
      } else if (e.key === 'End') {
        e.preventDefault();
        items.forEach(el => el.setAttribute('tabindex', '-1'));
        items[items.length - 1].setAttribute('tabindex', '0');
        items[items.length - 1].focus();
      }
    });

    // close on outside click
    document.addEventListener('click', (e) => {
      if (!root.contains(e.target) && isOpen()) closeMenu();
    });
  }
  wireDropdown('toolsDropdown');
  wireDropdown('dataDropdown');
</script>
<script>
// Header Dropdown functionality
document.addEventListener('DOMContentLoaded', function() {
  // Initialize dropdown functionality
  const dropdowns = document.querySelectorAll('.dropdown');
  
  dropdowns.forEach(dropdown => {
    const toggle = dropdown.querySelector('.dropdown-toggle');
    const menu = dropdown.querySelector('.dropdown-menu');
    
    if (toggle && menu) {
      toggle.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        // Close other dropdowns
        dropdowns.forEach(d => {
          if (d !== dropdown) {
            d.setAttribute('aria-expanded', 'false');
          }
        });
        
        // Toggle current dropdown
        const isOpen = dropdown.getAttribute('aria-expanded') === 'true';
        dropdown.setAttribute('aria-expanded', !isOpen);
        toggle.setAttribute('aria-expanded', !isOpen);
      });
    }
  });
  
  // Close dropdowns when clicking outside
  document.addEventListener('click', () => {
    dropdowns.forEach(dropdown => {
      dropdown.setAttribute('aria-expanded', 'false');
      const toggle = dropdown.querySelector('.dropdown-toggle');
      if (toggle) toggle.setAttribute('aria-expanded', 'false');
    });
  });
  
  // Handle keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      dropdowns.forEach(dropdown => {
        dropdown.setAttribute('aria-expanded', 'false');
        const toggle = dropdown.querySelector('.dropdown-toggle');
        if (toggle) toggle.setAttribute('aria-expanded', 'false');
      });
    }
  });
});
</script>
<script type="module">
  // Lazy-load heavy modules after first interaction/idle for performance
  const lazyModules = [
    './js/modules/advanced-charting.js',
    './js/modules/video-conference.js'
  ];
  function lazyImport() {
    lazyModules.forEach((m) => import(m).catch(() => {}));
    window.removeEventListener('pointerdown', lazyImportOnce);
    window.removeEventListener('keydown', lazyImportOnce);
  }
  function lazyImportOnce() { lazyImport(); }
  if ('requestIdleCallback' in window) {
    requestIdleCallback(() => lazyImport());
  } else {
    setTimeout(() => lazyImport(), 1500);
  }
  window.addEventListener('pointerdown', lazyImportOnce, { once: true });
  window.addEventListener('keydown', lazyImportOnce, { once: true });

  // Long task observer to surface main-thread jank during interactions
  if ('PerformanceObserver' in window) {
    try {
      const po = new PerformanceObserver((list) => {
        for (const entry of list.getEntries()) {
          if (entry.duration > 50) {
            console.info('[Perf] Long task detected', { duration: entry.duration.toFixed(1) + 'ms' });
          }
        }
      });
      po.observe({ entryTypes: ['longtask'] });
    } catch {}
  }
</script>
<script>
  // enable/disable multiple input based on selection
  const tvPerp = document.getElementById("tvPerp");
  const tvMultiple = document.getElementById("tvMultiple");
  const tvMultipleVal = document.getElementById("tvMultipleVal");
  function updateTvControls(){
    if (!tvPerp || !tvMultiple || !tvMultipleVal) return;
    tvMultipleVal.disabled = tvPerp.checked;
  }
  tvPerp?.addEventListener("change", updateTvControls);
  tvMultiple?.addEventListener("change", updateTvControls);
  updateTvControls();
</script>
</body>
</html>
